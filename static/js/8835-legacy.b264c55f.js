"use strict";(self["webpackChunkvue_url_arcgis"]=self["webpackChunkvue_url_arcgis"]||[]).push([[8835],{5246:function(e,t,r){r.d(t,{XO:function(){return n},pJ:function(){return i}});r(35837),r(41539),r(74916),r(4723),r(15306),r(92222);function n(e){return e=e||globalThis.location.hostname,l.some((function(t){var r;return null!=(null==(r=e)?void 0:r.match(t))}))}function i(e,t){return e&&(t=t||globalThis.location.hostname)?null!=t.match(a)||null!=t.match(s)?e.replace("static.arcgis.com","staticdev.arcgis.com"):null!=t.match(u)||null!=t.match(o)?e.replace("static.arcgis.com","staticqa.arcgis.com"):e:e}var a=/^devext.arcgis.com$/,u=/^qaext.arcgis.com$/,s=/^[\w-]*\.mapsdevext.arcgis.com$/,o=/^[\w-]*\.mapsqa.arcgis.com$/,l=[/^([\w-]*\.)?[\w-]*\.zrh-dev-local.esri.com$/,a,u,/^jsapps.esri.com$/,s,o]},58798:function(e,t,r){r.d(t,{G6:function(){return O},Ie:function(){return q},J9:function(){return F},RF:function(){return E},U1:function(){return I},vY:function(){return l},ym:function(){return S}});var n=r(2394),i=(r(9653),r(27092)),a=r(64316);var u=function(e,t,r){return[t,r]},s=function(e,t,r){return[t,r,e[2]]},o=function(e,t,r){return[t,r,e[2],e[3]]};function l(e){return e?{originPosition:"upper-left"===e.originPosition?"upperLeft":"lower-left"===e.originPosition?"lowerLeft":e.originPosition,scale:e.tolerance?[e.tolerance,e.tolerance]:[1,1],translate:(0,i.pC)(e.extent)?[e.extent.xmin,e.extent.ymax]:[0,0]}:null}function c(e,t){var r=e.scale,n=e.translate;return Math.round((t-n[0])/r[0])}function p(e,t){var r=e.scale,n=e.translate;return Math.round((n[1]-t)/r[1])}function f(e,t,r){for(var n,i,a,u,s=[],o=0;o<r.length;o++){var l=r[o];o>0?(a=c(e,l[0]),u=p(e,l[1]),a===n&&u===i||(s.push(t(l,a-n,u-i)),n=a,i=u)):(n=c(e,l[0]),i=p(e,l[1]),s.push(t(l,n,i)))}return s.length>0?s:null}function h(e,t,r,n){return f(e,r?n?o:s:n?s:u,t)}function d(e,t,r,n){for(var i=[],a=r?n?o:s:n?s:u,l=0;l<t.length;l++){var c=f(e,a,t[l]);c&&c.length>=3&&i.push(c)}return i.length?i:null}function y(e,t,r,n){for(var i=[],a=r?n?o:s:n?s:u,l=0;l<t.length;l++){var c=f(e,a,t[l]);c&&c.length>=2&&i.push(c)}return i.length?i:null}function v(e,t){var r=e.scale,n=e.translate;return t*r[0]+n[0]}function m(e,t){var r=e.scale,n=e.translate;return n[1]-t*r[1]}function g(e,t,r){var i=new Array(r.length);if(!r.length)return i;var a=(0,n.Z)(e.scale,2),u=a[0],s=a[1],o=v(e,r[0][0]),l=m(e,r[0][1]);i[0]=t(r[0],o,l);for(var c=1;c<r.length;c++){var p=r[c];o+=p[0]*u,l-=p[1]*s,i[c]=t(p,o,l)}return i}function _(e,t,r){for(var n=new Array(r.length),i=0;i<r.length;i++)n[i]=g(e,t,r[i]);return n}function x(e,t,r,n){return g(e,r?n?o:s:n?s:u,t)}function b(e,t,r,n){return _(e,r?n?o:s:n?s:u,t)}function w(e,t,r,n){return _(e,r?n?o:s:n?s:u,t)}function k(e,t,r,n,i){return t.xmin=c(e,r.xmin),t.ymin=p(e,r.ymin),t.xmax=c(e,r.xmax),t.ymax=p(e,r.ymax),t!==r&&(n&&(t.zmin=r.zmin,t.zmax=r.zmax),i&&(t.mmin=r.mmin,t.mmax=r.mmax)),t}function R(e,t,r,n,i){return t.points=h(e,r.points,n,i),t}function E(e,t,r,n,i){return t.x=c(e,r.x),t.y=p(e,r.y),t!==r&&(n&&(t.z=r.z),i&&(t.m=r.m)),t}function Z(e,t,r,n,i){var a=d(e,r.rings,n,i);return a?(t.rings=a,t):null}function C(e,t,r,n,i){var a=y(e,r.paths,n,i);return a?(t.paths=a,t):null}function S(e,t){return e&&t?(0,a.wp)(t)?E(e,{},t,!1,!1):(0,a.l9)(t)?C(e,{},t,!1,!1):(0,a.oU)(t)?Z(e,{},t,!1,!1):(0,a.aW)(t)?R(e,{},t,!1,!1):(0,a.YX)(t)?k(e,{},t,!1,!1):null:null}function F(e,t,r,n,a){return(0,i.pC)(r)&&(t.points=x(e,r.points,n,a)),t}function I(e,t,r,n,a){return(0,i.Wi)(r)||(t.x=v(e,r.x),t.y=m(e,r.y),t!==r&&(n&&(t.z=r.z),a&&(t.m=r.m))),t}function q(e,t,r,n,a){return(0,i.pC)(r)&&(t.rings=w(e,r.rings,n,a)),t}function O(e,t,r,n,a){return(0,i.pC)(r)&&(t.paths=b(e,r.paths,n,a)),t}},58489:function(e,t,r){r.d(t,{k:function(){return s}});r(21249),r(57327),r(41539),r(54747);function n(e,t){return t?"xoffset"in t&&t.xoffset?Math.max(e,Math.abs(t.xoffset)):"yoffset"in t&&t.yoffset?Math.max(e,Math.abs(t.yoffset||0)):e:e}function i(e){for(var t=0,r=0,n=0;n<e.length;n++){var i=e[n].size;"number"==typeof i&&(t+=i,r++)}return t/r}function a(e,t){return"number"==typeof e?e:e&&e.stops&&e.stops.length?i(e.stops):t}function u(e,t){if(!t)return e;var r=t.filter((function(e){return"size"===e.type})).map((function(t){var r=t.maxSize,n=t.minSize;return(a(r,e)+a(n,e))/2})),n=0,i=r.length;if(0===i)return e;for(var u=0;u<i;u++)n+=r[u];var s=Math.floor(n/i);return Math.max(s,e)}function s(e){var t=e&&e.renderer,r="touch"===(e&&e.event&&e.event.pointerType)?9:6;if(!t)return r;var i="visualVariables"in t?u(r,t.visualVariables):r;if("simple"===t.type)return n(i,t.symbol);if("unique-value"===t.type){var a=i;return t.uniqueValueInfos.forEach((function(e){a=n(a,e.symbol)})),a}if("class-breaks"===t.type){var s=i;return t.classBreakInfos.forEach((function(e){s=n(s,e.symbol)})),s}return t.type,i}},74346:function(e,t,r){r.d(t,{a:function(){return o}});var n=r(25585),i=r(87441),a=r(49026),u=r(11047),s=i.Z.getLogger("esri.views.2d.engine.webgl");function o(e){return(0,u.hj)(e.minDataValue)&&(0,u.hj)(e.maxDataValue)&&null!=e.minSize&&null!=e.maxSize?a.X.SIZE_MINMAX_VALUE:(e.expression&&"view.scale"===e.expression||e.valueExpression&&"$view.scale"===e.valueExpression)&&Array.isArray(e.stops)?a.X.SIZE_SCALE_STOPS:(null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&(Array.isArray(e.stops)||"levels"in e&&e.levels)?a.X.SIZE_FIELD_STOPS:(null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&null!=e.valueUnit?a.X.SIZE_UNIT_VALUE:(s.error(new n.Z("mapview-bad-type","Found invalid size VisualVariable",e)),a.X.NONE)}},77926:function(e,t,r){r.r(t),r.d(t,{default:function(){return Re}});var n,i=r(4367),a=r(1936),u=r(62032),s=r(16198),o=r(76133),l=r(92751),c=r(50460),p=r(87349),f=r(99418),h=r(49161),d=(r(78975),r(41539),r(70189),r(78783),r(33948),r(51532),r(91038),r(38862),r(92222),r(83753),r(57327),r(21249),r(54747),r(68309),r(26699),r(32023),r(74916),r(15306),r(69600),r(24603),r(28450),r(88386),r(39714),r(73210),r(63825)),y=(r(9653),r(7380)),v=r(2553),m=(r(57787),r(35425)),g=(r(90202),r(92236)),_=n=function(e){(0,f.Z)(r,e);var t=(0,h.Z)(r);function r(){var e;return(0,o.Z)(this,r),e=t.apply(this,arguments),e.isAggregate=!0,e}return(0,l.Z)(r,[{key:"getEffectivePopupTemplate",value:function(){if(this.popupTemplate)return this.popupTemplate;var e=this.sourceLayer&&this.sourceLayer.featureReduction;return e&&"popupTemplate"in e&&e.popupEnabled?e.popupTemplate:null}},{key:"getObjectId",value:function(){return this.objectId}},{key:"clone",value:function(){return new n((0,i.Z)({objectId:this.objectId},this.cloneProperties()))}}]),r}(y.Z);(0,d._)([(0,v.Cb)({type:Boolean})],_.prototype,"isAggregate",void 0),(0,d._)([(0,v.Cb)({type:Number,json:{read:!0}})],_.prototype,"objectId",void 0),_=n=(0,d._)([(0,g.j)("esri.AggregateGraphic")],_);var x=_,b=(r(75065),r(54643)),w=r(25585),k=r(40199),R=r(87441),E=r(27092),Z=r(24446),C=r(39309),S=r(44621),F=r(44171),I=r(79204),q=function(e){(0,f.Z)(r,e);var t=(0,h.Z)(r);function r(e){var n;return(0,o.Z)(this,r),n=t.call(this,e),n._filter=null,n.duration=(0,m.Z)("mapview-transitions-duration"),n._excludedEffectView=new I.ZP(e),n._includedEffectView=new I.ZP(e),n}return(0,l.Z)(r,[{key:"excludedEffects",get:function(){return this._excludedEffectView.effects}},{key:"featureEffect",set:function(e){this._get("featureEffect")!==e&&this._transitionTo(e)}},{key:"filter",get:function(){var e;return this._filter||(null==(e=(0,E.Wg)(this.featureEffect))?void 0:e.filter)||null}},{key:"hasEffects",get:function(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}},{key:"includedEffects",get:function(){return this._includedEffectView.effects}},{key:"scale",set:function(e){this._set("scale",e),this._excludedEffectView.scale=e,this._includedEffectView.scale=e}},{key:"transitioning",get:function(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}},{key:"transitionStep",value:function(e,t){this._set("scale",t),this.transitioning?(this._includedEffectView.transitionStep(e,t),this._excludedEffectView.transitionStep(e,t),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=t,this._includedEffectView.scale=t)}},{key:"end",value:function(){this._includedEffectView.end(),this._excludedEffectView.end(),this._filter=null}},{key:"_transitionTo",value:function(e){var t=this._get("featureEffect"),r=(0,E.Wg)(e),n=(0,E.Wg)(null==r?void 0:r.includedEffect),i=(0,E.Wg)(null==r?void 0:r.excludedEffect),a=this._includedEffectView.canTransitionTo(n)&&this._excludedEffectView.canTransitionTo(i);this._includedEffectView.effect=n,this._excludedEffectView.effect=i,this._set("featureEffect",r),this._filter=(null==r?void 0:r.filter)||(null==t?void 0:t.filter)||null,a||this.end()}}]),r}(F.Z);(0,d._)([(0,v.Cb)()],q.prototype,"_filter",void 0),(0,d._)([(0,v.Cb)()],q.prototype,"_excludedEffectView",void 0),(0,d._)([(0,v.Cb)()],q.prototype,"_includedEffectView",void 0),(0,d._)([(0,v.Cb)()],q.prototype,"duration",void 0),(0,d._)([(0,v.Cb)()],q.prototype,"excludedEffects",null),(0,d._)([(0,v.Cb)()],q.prototype,"featureEffect",null),(0,d._)([(0,v.Cb)()],q.prototype,"filter",null),(0,d._)([(0,v.Cb)()],q.prototype,"hasEffects",null),(0,d._)([(0,v.Cb)()],q.prototype,"includedEffects",null),(0,d._)([(0,v.Cb)({value:0})],q.prototype,"scale",null),(0,d._)([(0,v.Cb)()],q.prototype,"transitioning",null),q=(0,d._)([(0,g.j)("esri.layers.effects.FeatureEffectView")],q);var O=q,V=r(35408),T=r(58489),P=r(7804),U=r(17562),N=r(92963),A=r(21211),z=r(61112);function L(e,t){return M.apply(this,arguments)}function M(){return M=(0,s.Z)(regeneratorRuntime.mark((function e(t,n){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return",null);case 2:e.t0=t.type,e.next="class-breaks"===e.t0||"simple"===e.t0||"unique-value"===e.t0||"dot-density"===e.t0||"dictionary"===e.t0?5:"heatmap"===e.t0?10:15;break;case 5:return e.next=7,Promise.all([r.e(8547),r.e(4708),r.e(7303),r.e(9128),r.e(2596)]).then(r.bind(r,85258));case 7:return e.t1=e.sent.default,e.t2=n,e.abrupt("return",new e.t1(e.t2));case 10:return e.next=12,Promise.all([r.e(8547),r.e(4708),r.e(7303),r.e(5997),r.e(7219)]).then(r.bind(r,77219));case 12:return e.t3=e.sent.default,e.t4=n,e.abrupt("return",new e.t3(e.t4));case 15:case"end":return e.stop()}}),e)}))),M.apply(this,arguments)}var j=r(81768),J=r(30751),H=r(46201);function B(e){return e.some((function(e){return e.globalId}))}function D(e){return e.filter((function(e){return!e.error})).map((function(e){var t;return null!=(t=e.objectId)?t:e.globalId}))}function Q(e,t){var r,n=new Set(e),i=(0,u.Z)(t.values());try{for(i.s();!(r=i.n()).done;){var a=r.value;n.add(a)}}catch(s){i.e(s)}finally{i.f()}return n}function G(e,t){var r,n=new Set(e),i=(0,u.Z)(t.values());try{for(i.s();!(r=i.n()).done;){var a=r.value;n.delete(a)}}catch(s){i.e(s)}finally{i.f()}return n}var K=function(e){(0,f.Z)(r,e);var t=(0,h.Z)(r);function r(e){var n;return(0,o.Z)(this,r),n=t.call(this,e),n._hasGlobalIds=!1,n}return(0,l.Z)(r,[{key:"normalizeCtorArgs",value:function(e){return this._queueProcessor=new H.e({concurrency:1,process:e.process}),{}}},{key:"destroy",value:function(){this._queueProcessor.clear()}},{key:"updating",get:function(){return this._queueProcessor.length>0}},{key:"push",value:function(e){var t=this,r=this._queueProcessor,n=r.last();switch(e.type){case"update":case"refresh":if((null==n?void 0:n.type)===e.type)return;r.push(e).finally((function(){return t.notifyChange("updating")}));break;case"edit":var i="processed-edit"===(null==n?void 0:n.type)?n:null;i&&r.popLast();var a,s=this._mergeEdits(i,e),o=(0,u.Z)(s);try{for(o.s();!(a=o.n()).done;){var l=a.value;r.push(l).finally((function(){return t.notifyChange("updating")}))}}catch(c){o.e(c)}finally{o.f()}break}this.notifyChange("updating")}},{key:"_mergeEdits",value:function(e,t){var r,n,i=t.edits,u=i.addedFeatures,s=i.deletedFeatures,o=i.updatedFeatures;if(this._hasGlobalIds=this._hasGlobalIds||B(u)||B(o)||B(s),this._hasGlobalIds)return[e,{type:"processed-edit",edits:{addOrModified:[].concat((0,a.Z)(u),(0,a.Z)(o)),removed:s}}];var l=new Set(D(null!=(r=null==e?void 0:e.edits.addOrModified)?r:[])),c=new Set(D(null!=(n=null==e?void 0:e.edits.removed)?n:[])),p=new Set([].concat((0,a.Z)(D(u)),(0,a.Z)(D(o)))),f=new Set(D(s));return[{type:"processed-edit",edits:{addOrModified:Array.from(Q(G(l,f),p)).map((function(e){return{objectId:e}})),removed:Array.from(Q(G(c,p),f)).map((function(e){return{objectId:e}}))}}]}}]),r}(F.Z);(0,d._)([(0,v.Cb)({readOnly:!0})],K.prototype,"updating",null),K=(0,d._)([(0,g.j)("esri.views.2d.layers.support.FeatureCommandQueue")],K);var W=K,X=r(69324),$=r(17044);function Y(e){return Array.isArray(e)}var ee=function(e){(0,f.Z)(r,e);var t=(0,h.Z)(r);function r(e){var n;return(0,o.Z)(this,r),n=t.call(this,e),n._startupResolver=(0,Z.hh)(),n.isReady=!1,n}return(0,l.Z)(r,[{key:"initialize",value:function(){this._controller=new AbortController,this.addResolvingPromise(this._startWorker(this._controller.signal))}},{key:"destroy",value:function(){this._controller.abort(),this._connection&&this._connection.close()}},{key:"tileRenderer",set:function(e){this.client.tileRenderer=e}},{key:"closed",get:function(){return this._connection.closed}},{key:"startup",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r,n,i){var a,u,s;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.when();case 2:return a=this._controller.signal,u=Y(n.source)?{transferList:n.source,signal:a}:void 0,s={service:n,config:r,tileInfo:t.tileInfo.toJSON(),tiles:i},e.next=5,this._connection.invoke("startup",s,u);case 5:this._startupResolver.resolve(),this._set("isReady",!0);case 7:case"end":return e.stop()}}),e,this)})));function t(t,r,n,i){return e.apply(this,arguments)}return t}()},{key:"updateTiles",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,Z.R8)(this._connection.invoke("updateTiles",t)));case 3:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"update",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r={config:t},e.next=3,this._startupResolver.promise;case 3:return e.abrupt("return",this._connection.invoke("update",r));case 4:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"applyUpdate",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("applyUpdate",t));case 3:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"setHighlight",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,Z.R8)(this._connection.invoke("controller.setHighlight",t)));case 3:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"refresh",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,Z.R8)(this._connection.invoke("controller.refresh",t)));case 3:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"querySummaryStatistics",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r,n){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.querySummaryStatistics",{query:t.toJSON(),params:r},n));case 3:case"end":return e.stop()}}),e,this)})));function t(t,r,n){return e.apply(this,arguments)}return t}()},{key:"queryUniqueValues",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r,n){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryUniqueValues",{query:t.toJSON(),params:r},n));case 3:case"end":return e.stop()}}),e,this)})));function t(t,r,n){return e.apply(this,arguments)}return t}()},{key:"queryClassBreaks",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r,n){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryClassBreaks",{query:t.toJSON(),params:r},n));case 3:case"end":return e.stop()}}),e,this)})));function t(t,r,n){return e.apply(this,arguments)}return t}()},{key:"queryHistogram",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r,n){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryHistogram",{query:t.toJSON(),params:r},n));case 3:case"end":return e.stop()}}),e,this)})));function t(t,r,n){return e.apply(this,arguments)}return t}()},{key:"queryFeatures",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryFeatures",t.toJSON(),r));case 3:case"end":return e.stop()}}),e,this)})));function t(t,r){return e.apply(this,arguments)}return t}()},{key:"queryVisibleFeatures",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryVisibleFeatures",t.toJSON(),r));case 3:case"end":return e.stop()}}),e,this)})));function t(t,r){return e.apply(this,arguments)}return t}()},{key:"queryObjectIds",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryObjectIds",t.toJSON(),r));case 3:case"end":return e.stop()}}),e,this)})));function t(t,r){return e.apply(this,arguments)}return t}()},{key:"queryFeatureCount",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryFeatureCount",t.toJSON(),r));case 3:case"end":return e.stop()}}),e,this)})));function t(t,r){return e.apply(this,arguments)}return t}()},{key:"queryExtent",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",this._connection.invoke("controller.queryExtent",t.toJSON(),r));case 1:case"end":return e.stop()}}),e,this)})));function t(t,r){return e.apply(this,arguments)}return t}()},{key:"queryLatestObservations",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryLatestObservations",t.toJSON(),r));case 3:case"end":return e.stop()}}),e,this)})));function t(t,r){return e.apply(this,arguments)}return t}()},{key:"queryStatistics",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.queryStatistics",t));case 3:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"getObjectId",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.getObjectId",t));case 3:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"getDisplayId",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.getDisplayId",t));case 3:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"getFeatures",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.getFeatures",t));case 3:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"getAggregates",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.getAggregates"));case 3:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"getAggregateValueRanges",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.getAggregateValueRanges"));case 3:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"mapValidDisplayIds",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",this._connection.invoke("controller.mapValidDisplayIds",t));case 3:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"onEdits",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,Z.R8)(this._connection.invoke("controller.onEdits",t)));case 3:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"enableEvent",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._startupResolver.promise;case 2:return e.abrupt("return",(0,Z.R8)(this._connection.invoke("controller.enableEvent",{name:t,value:r})));case 3:case"end":return e.stop()}}),e,this)})));function t(t,r){return e.apply(this,arguments)}return t}()},{key:"_startWorker",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,$.bA)("Pipeline",{client:this.client,strategy:"dedicated",signal:t});case 3:this._connection=e.sent,e.next=9;break;case 6:e.prev=6,e.t0=e["catch"](0),(0,Z.H9)(e.t0);case 9:case"end":return e.stop()}}),e,this,[[0,6]])})));function t(t){return e.apply(this,arguments)}return t}()}]),r}(X.D);(0,d._)([(0,v.Cb)()],ee.prototype,"isReady",void 0),(0,d._)([(0,v.Cb)()],ee.prototype,"client",void 0),(0,d._)([(0,v.Cb)()],ee.prototype,"tileRenderer",null),ee=(0,d._)([(0,g.j)("esri.views.2d.layers.support.FeatureLayerProxy")],ee);var te=ee,re=r(32257),ne=r(80427),ie=r(12744),ae=1e-6,ue=function(){function e(t){(0,o.Z)(this,e),this._tiles=new Map,this.buffer=0,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,this.buffer=t.buffer}return(0,l.Z)(e,[{key:"destroy",value:function(){}},{key:"clear",value:function(){var e=this;this._tiles.forEach((function(t){return e._releaseTile(t)}))}},{key:"tileKeys",value:function(){var e=[];return this._tiles.forEach((function(t,r){return e.push(r)})),e}},{key:"update",value:function(e){var t,r=this,n=this.tileInfoView.getTileCoverage(e.state,this.buffer,"closest"),i=n.spans,a=n.lodInfo,s=a.level,o=[],l=[],c=new Set,p=new Set,f=(0,u.Z)(i);try{for(f.s();!(t=f.n()).done;)for(var h=t.value,d=h.row,y=h.colFrom,v=h.colTo,m=y;m<=v;m++){var g=ie.Z.getId(s,d,a.normalizeCol(m),a.getWorldForColumn(m)),_=this._getOrAcquireTile(o,g);c.add(g),_.isReady?_.visible=!0:p.add(_.key)}}catch(x){f.e(x)}finally{f.f()}return p.forEach((function(e){return r._addPlaceholders(c,e)})),this._tiles.forEach((function(e){c.has(e.key.id)||(l.push(e.key.id),r._releaseTile(e))})),ne.Z.pool.release(n),{hasMissingTiles:p.size>0,added:o,removed:l}}},{key:"_getOrAcquireTile",value:function(e,t){if(!this._tiles.has(t)){var r=this.acquireTile(new ie.Z(t));e.push(t),this._tiles.set(t,r),r.visible=!1}return this._tiles.get(t)}},{key:"_getTile",value:function(e){return this._tiles.get(e)}},{key:"_releaseTile",value:function(e){this._tiles.delete(e.key.id),this.releaseTile(e)}},{key:"_addPlaceholders",value:function(e,t){var r=this._addPlaceholderChildren(e,t);Math.abs(1-r)<ae||this._addPlaceholderParent(e,t)||(this._getTile(t.id).visible=!0)}},{key:"_addPlaceholderChildren",value:function(e,t){var r=this,n=0;return this._tiles.forEach((function(i){n+=r._addPlaceholderChild(e,i,t)})),n}},{key:"_addPlaceholderChild",value:function(e,t,r){return t.key.level<=r.level||!t.hasData||!r.contains(t.key)?0:(t.visible=!0,e.add(t.key.id),1/(1<<2*(t.key.level-r.level)))}},{key:"_addPlaceholderParent",value:function(e,t){for(var r=t.getParentKey(),n=0,i=null;(0,E.pC)(r);){if(e.has(r.id))return!0;var a=this._getTile(r.id);if(null!=a&&a.isReady)return a.visible=!0,e.add(a.key.id),!0;null!=a&&a.hasData&&a.patchCount>n&&(n=a.patchCount,i=a),r=r.getParentKey()}return!!i&&(i.visible=!0,e.add(i.key.id),!0)}}]),e}(),se=(r(21703),r(2707),r(69768)),oe=r(15387),le=r(24023),ce=r(63390),pe=r(74887),fe=r(66541),he=r(69505),de=R.Z.getLogger("esri.views.layers.FeatureLayerView"),ye=function(e){var t=function(e){(0,f.Z)(r,e);var t=(0,h.Z)(r);function r(){var e;(0,o.Z)(this,r);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return e=t.call.apply(t,[this].concat(i)),e._updatingRequiredFieldsPromise=null,e.filter=null,e.timeExtent=null,e.layer=null,e.requiredFields=[],e.view=null,e}return(0,l.Z)(r,[{key:"initialize",value:function(){var e=this;(0,S.S1)(this,["layer.renderer","layer.labelingInfo","layer.elevationInfo.featureExpressionInfo","layer.displayField","filter","featureEffect","layer.timeInfo","layer.floorInfo","timeExtent"],(function(){return e._handleRequiredFieldsChange()}),!0),(0,S.on)(this,"view.floors","change",(function(){return e._handleRequiredFieldsChange()})),(0,S.on)(this,"layer.sublayer","change",(function(){return e._handleRequiredFieldsChange()}))}},{key:"availableFields",get:function(){var e=this.layer,t=this.layer.fieldsIndex,r=this.requiredFields;return"outFields"in e&&e.outFields?(0,ce.Q0)(t,[].concat((0,a.Z)((0,ce.Lk)(t,e.outFields)),(0,a.Z)(r))):(0,ce.Q0)(t,r)}},{key:"effect",get:function(){return(0,se.Mr)(de,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect},set:function(e){(0,se.Mr)(de,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect=e}},{key:"featureEffect",get:function(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null},set:function(e){void 0!==e?this._override("featureEffect",e):this._clearOverride("featureEffect")}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(e){de.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}},{key:"highlight",value:function(e){throw new Error("missing implementation")}},{key:"createQuery",value:function(){var e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=(0,E.pC)(this.filter)?this.filter.createQuery(e):new U.Z(e);if("feature"===this.layer.type){var r=(0,he.cx)(this);(0,E.pC)(r)&&(t.where=t.where?"(".concat(t.where,") AND (").concat(r,")"):r)}return(0,E.pC)(this.timeExtent)&&(t.timeExtent=(0,E.pC)(t.timeExtent)?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}},{key:"queryFeatures",value:function(e,t){throw new Error("missing implementation")}},{key:"queryObjectIds",value:function(e,t){throw new Error("missing implementation")}},{key:"queryFeatureCount",value:function(e,t){throw new Error("missing implementation")}},{key:"queryExtent",value:function(e,t){throw new Error("missing implementation")}},{key:"fetchPopupFeatures",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r){var n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=this.validateFetchPopupFeatures(r),!n){e.next=3;break}throw n;case 3:return e.abrupt("return",this.fetchClientPopupFeatures(r));case 4:case"end":return e.stop()}}),e,this)})));function t(t,r){return e.apply(this,arguments)}return t}()},{key:"_loadArcadeModules",value:function(e){if(e.get("expressionInfos.length")||Array.isArray(e.content)&&e.content.some((function(e){return"expression"===e.type})))return(0,pe.LC)()}},{key:"_handleRequiredFieldsChange",value:function(){var e=this,t=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",t),t.then((function(){e._updatingRequiredFieldsPromise===t&&e._set("_updatingRequiredFieldsPromise",null)}))}},{key:"_updateRequiredFields",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(){var t,r,n,i,a,s,o,l,c,p,f,h,d,y,v;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(this.layer&&this.view){e.next=2;break}return e.abrupt("return");case 2:return t="3d"===this.view.type,r=this.layer,n=this.layer,i=n.fieldsIndex,a=n.objectIdField,s="renderer"in r&&r.renderer,o="orderBy"in r&&r.orderBy,l=r.featureReduction,c=new Set,e.next=13,(0,Z.as)([s?s.collectRequiredFields(c,i):null,(0,ce.Mu)(c,r),t?(0,ce.vl)(c,r):null,(0,E.pC)(this.filter)?(0,ce.Ll)(c,r,this.filter):null,(0,E.pC)(this.featureEffect)?(0,ce.Ll)(c,r,this.featureEffect.filter):null,l?(0,ce.ZV)(c,r,l):null,o?(0,ce.Qj)(c,r,o):null]);case 13:if(p=e.sent,r.timeInfo&&this.timeExtent&&(0,ce.gd)(c,r.fieldsIndex,[r.timeInfo.startField,r.timeInfo.endField]),"feature"===r.type&&r.floorInfo&&(0,ce.gd)(c,r.fieldsIndex,[r.floorInfo.floorField]),"subtype-group"!==r.type){e.next=19;break}return(0,ce.AB)(c,i,r.subtypeField),f=r.sublayers.map((function(e){var t;return Promise.all([null==(t=e.renderer)?void 0:t.collectRequiredFields(c,i),(0,ce.Mu)(c,e)])})),e.next=19,(0,Z.as)(f);case 19:h=(0,u.Z)(p);try{for(h.s();!(d=h.n()).done;)y=d.value,y.error&&de.error(y.error)}catch(m){h.e(m)}finally{h.f()}(0,ce.AB)(c,i,a),t&&"displayField"in r&&r.displayField&&(0,ce.AB)(c,i,r.displayField),v=Array.from(c).sort(),this._set("requiredFields",v);case 24:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"validateFetchPopupFeatures",value:function(e){if((0,E.Wi)(e))return null;var t,r=(0,u.Z)(e.clientGraphics);try{for(r.s();!(t=r.n()).done;){var n=t.value,i=n.layer;if("popupEnabled"in i&&!i.popupEnabled)return new w.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:i});if("popupTemplate"in i&&!(0,fe.V)(i,e))return new w.Z("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:i});if(n.isAggregate&&!(i.featureReduction&&"popupTemplate"in i.featureReduction&&i.featureReduction.popupEnabled&&i.featureReduction.popupTemplate))return new w.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:i})}}catch(a){r.e(a)}finally{r.f()}}},{key:"fetchClientPopupFeatures",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){var r,n,i,a,s,o,l,c,p,f,h,d,y,v;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r=(0,E.pC)(t)?t.clientGraphics:null,r&&0!==r.length){e.next=3;break}return e.abrupt("return",[]);case 3:return n=new Array(r.length),i=new Map,e.next=7,this.createPopupQuery(t);case 7:a=e.sent,s=0;case 9:if(!(s<r.length)){e.next=27;break}if(o=r[s],!o.isAggregate){e.next=14;break}return n[s]=o,e.abrupt("continue",24);case 14:if(l=o.layer,"popupEnabled"in l){e.next=17;break}return e.abrupt("continue",24);case 17:if(c=(0,ce.Lk)(this.layer.fieldsIndex,a.outFields),p=(0,fe.V)(l,t),(0,E.pC)(p)){e.next=20;break}return e.abrupt("continue",24);case 20:return e.next=22,this._loadArcadeModules(p);case 22:f=e.sent,f&&f.arcadeUtils.hasGeometryOperations(p)||!(0,ce.R9)(c,o)?i.set(o.getObjectId(),s):n[s]=o;case 24:s++,e.next=9;break;case 27:if("stream"!==this.layer.type&&0!==i.size){e.next=29;break}return e.abrupt("return",n.filter(Boolean));case 29:return a.objectIds=Array.from(i.keys()),e.prev=30,e.next=33,this.layer.queryFeatures(a);case 33:h=e.sent,d=(0,u.Z)(h.features);try{for(d.s();!(y=d.n()).done;)v=y.value,n[i.get(v.getObjectId())]=v}catch(m){d.e(m)}finally{d.f()}e.next=40;break;case 38:e.prev=38,e.t0=e["catch"](30);case 40:return e.abrupt("return",n.filter(Boolean));case 41:case"end":return e.stop()}}),e,this,[[30,38]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"createPopupQuery",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){var r,n,i,a,s,o,l,c,p,f,h,d,y,v,m;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:r=this.layer.createQuery(),n=new Set,i=!1,a=(0,E.pC)(t)&&t.clientGraphics?t.clientGraphics.map((function(e){return e.layer})):[this.layer],s=(0,u.Z)(a),e.prev=4,s.s();case 6:if((o=s.n()).done){e.next=25;break}if(l=o.value,"popupEnabled"in l){e.next=10;break}return e.abrupt("continue",23);case 10:if(c=(0,fe.V)(l,t),(0,E.pC)(c)){e.next=13;break}return e.abrupt("continue",23);case 13:return e.next=15,this._loadArcadeModules(c);case 15:return p=e.sent,f=p&&p.arcadeUtils.hasGeometryOperations(c),i=!("point"!==this.layer.geometryType&&!f),e.next=20,(0,fe.e)(this.layer,c);case 20:h=e.sent,d=(0,u.Z)(h);try{for(d.s();!(y=d.n()).done;)v=y.value,n.add(v)}catch(g){d.e(g)}finally{d.f()}case 23:e.next=6;break;case 25:e.next=30;break;case 27:e.prev=27,e.t0=e["catch"](4),s.e(e.t0);case 30:return e.prev=30,s.f(),e.finish(30);case 33:return r.returnGeometry=i,r.returnZ=i,r.returnM=i,r.outFields=Array.from(n),r.outSpatialReference=this.view.spatialReference,"feature"===this.layer.type&&(m=(0,he.cx)(this),(0,E.pC)(m)&&(r.where=r.where?"(".concat(r.where,") AND (").concat(m,")"):m)),e.abrupt("return",r);case 35:case"end":return e.stop()}}),e,this,[[4,27,30,33]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"canResume",value:function(){return!!(0,c.Z)((0,p.Z)(r.prototype),"canResume",this).call(this)&&(!(0,E.pC)(this.timeExtent)||!this.timeExtent.isEmpty)}}]),r}(e);return(0,d._)([(0,v.Cb)()],t.prototype,"_updatingRequiredFieldsPromise",void 0),(0,d._)([(0,v.Cb)({readOnly:!0})],t.prototype,"availableFields",null),(0,d._)([(0,v.Cb)()],t.prototype,"effect",null),(0,d._)([(0,v.Cb)({type:le.Z})],t.prototype,"featureEffect",null),(0,d._)([(0,v.Cb)({type:V.Z})],t.prototype,"filter",void 0),(0,d._)([(0,v.Cb)(oe.qG)],t.prototype,"timeExtent",void 0),(0,d._)([(0,v.Cb)()],t.prototype,"layer",void 0),(0,d._)([(0,v.Cb)({type:Number})],t.prototype,"maximumNumberOfFeatures",null),(0,d._)([(0,v.Cb)({readOnly:!0,type:Boolean})],t.prototype,"maximumNumberOfFeaturesExceeded",null),(0,d._)([(0,v.Cb)({readOnly:!0})],t.prototype,"requiredFields",void 0),(0,d._)([(0,v.Cb)()],t.prototype,"suspended",void 0),(0,d._)([(0,v.Cb)()],t.prototype,"view",void 0),t=(0,d._)([(0,g.j)("esri.views.layers.FeatureLayerView")],t),t},ve=r(74139),me=r(68801),ge=r(96237),_e=r(11277),xe=r(7230);function be(e){return e&&"openPorts"in e}var we=R.Z.getLogger("esri.views.2d.layers.FeatureLayerView2D"),ke=function(e){(0,f.Z)(r,e);var t=(0,h.Z)(r);function r(){var e;return(0,o.Z)(this,r),e=t.apply(this,arguments),e._pipelineIsUpdating=!0,e._commandsQueue=new W({process:function(t){switch(t.type){case"processed-edit":return e._doEdit(t);case"refresh":return e._doRefresh(t.dataChanged);case"update":return e._doUpdate()}}}),e._visibilityOverrides=new Set,e._highlightIds=new Map,e._lastPixelBuffer=0,e._updateHighlight=(0,Z.Ds)((0,s.Z)(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.abrupt("return",e._proxy.setHighlight(Array.from(e._highlightIds.keys())));case 1:case"end":return t.stop()}}),t)})))),e._uploadsLocked=!1,e._needsClusterSizeUpdate=!1,e.featureEffectView=new O,e._lastDefinitionExpression=null,e}return(0,l.Z)(r,[{key:"destroy",value:function(){var e,t;(0,E.Po)(this._updateClusterSizeTask,(function(e){return e.remove()})),null==(e=this._proxy)||e.destroy(),null==(t=this.tileRenderer)||t.destroy(),this._commandsQueue.destroy()}},{key:"initialize",value:function(){var e=this;this.addResolvingPromise(Promise.all([this._initProxy(),this._initServiceOptions()])),this.handles.add([this.on("valueRangesChanged",(function(t){e._set("_aggregateValueRanges",t.valueRanges)})),(0,C.Ym)((function(){return e.featureEffect}),(function(t){e.featureEffectView.featureEffect=t}),{initial:!0,sync:!0})])}},{key:"_initProxy",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!("isTable"in this.layer)||!this.layer.isTable){e.next=2;break}throw new w.Z("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:this.layer});case 2:return this._proxy&&this._proxy.destroy(),t=this._createClientOptions(),e.abrupt("return",(this._set("_proxy",new te({client:t})),this._proxy.when()));case 5:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"_initServiceOptions",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.t0=this,e.next=3,this._createServiceOptions();case 3:e.t1=e.sent,e.t0._set.call(e.t0,"_serviceOptions",e.t1);case 5:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"orderByFields",get:function(){return"stream"!==this._serviceOptions.type&&this._serviceOptions.orderByFields}},{key:"labelsVisible",get:function(){var e="subtype-group"===this.layer.type?this.layer.sublayers.items:[this.layer];return!this.suspended&&e.some((function(e){return e.labelingInfo&&e.labelsVisible}))}},{key:"queryMode",get:function(){return this._serviceOptions.type}},{key:"renderingConfigHash",get:function(){if(!this.layer)return null;var e=this.availableFields,t=this.layer,r=this.view.floors,n=t.definitionExpression,i="subtype-group"!==this.layer.type&&this.layer.labelsVisible&&this.layer.labelingInfo,a="renderer"in t&&t.renderer,u="feature"===t.type?t.gdbVersion:void 0,s="feature"===t.type&&t.historicMoment?t.historicMoment.getTime():void 0,o=this.timeExtent,l="customParameters"in t?JSON.stringify(t.customParameters):void 0,c="apiKey"in t?t.apiKey:void 0,p="stream"===t.type?"".concat(JSON.stringify(t.geometryDefinition)).concat(t.definitionExpression):null,f=JSON.stringify(this.clips),h=t.featureReduction&&t.featureReduction.toJSON(),d="orderBy"in this.layer&&JSON.stringify(this.layer.orderBy),y="sublayers"in this.layer&&this.layer.sublayers.items.reduce((function(e,t){return e+"".concat(t.visible?1:0,".").concat(JSON.stringify(t.renderer),".").concat(t.labelsVisible,"\n.").concat(JSON.stringify(t.labelingInfo))}),"");return JSON.stringify({orderBy:d,sublayerHash:y,filterHash:(0,E.pC)(this.filter)&&this.filter.toJSON(),effectHash:(0,E.pC)(this.featureEffect)&&this.featureEffect.toJSON(),streamFilter:p,gdbVersion:u,definitionExpression:n,historicMoment:s,availableFields:e,renderer:a,labelingInfo:i,timeExtent:o,floors:r,clipsHash:f,featureReduction:h,customParameters:l,apiKey:c})}},{key:"fetchPopupFeatures",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,n){var i,a,s,o,l,f,h,d,y;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!(0,E.pC)(n)||0!==n.clientGraphics.length){e.next=2;break}return e.abrupt("return",[]);case 2:if("cluster"===(null==(i=this.layer.featureReduction)?void 0:i.type)){e.next=13;break}return a=(0,T.k)({renderer:"renderer"in this.layer&&this.layer.renderer,event:(0,E.pC)(n)&&n.event}),s=(0,ge.K)(t,a,this.view),e.next=7,this.queryVisibleFeatures(new U.Z({geometry:s,outFields:["*"],returnGeometry:!0}));case 7:o=e.sent,l=o.features,n=(0,E.pC)(n)?n:{},f=new Set(n.clientGraphics.map((function(e){return e.getObjectId()}))),h=(0,u.Z)(l);try{for(h.s();!(d=h.n()).done;)y=d.value,f.has(y.getObjectId())||n.clientGraphics.push(y)}catch(v){h.e(v)}finally{h.f()}case 13:return e.abrupt("return",(0,c.Z)((0,p.Z)(r.prototype),"fetchPopupFeatures",this).call(this,t,n));case 14:case"end":return e.stop()}}),e,this)})));function t(t,r){return e.apply(this,arguments)}return t}()},{key:"highlight",value:function(e){var t,r,n=this;return e instanceof y.Z?r=[e.getObjectId()]:"number"==typeof e||"string"==typeof e?r=[e]:Array.isArray(e)&&e.length>0?r="number"==typeof e[0]||"string"==typeof e[0]?e:e.map((function(e){return null==e?void 0:e.getObjectId()})):b.Z.isCollection(e)&&e.length>0&&(r=e.map((function(e){return null==e?void 0:e.getObjectId()})).toArray()),r=null==(t=r)?void 0:t.filter((function(e){return null!=e})),r&&r.length?(this._addHighlight(r),{remove:function(){return n._removeHighlight(r)}}):{remove:function(){}}}},{key:"hasHighlight",value:function(){return!!this._highlightIds.size}},{key:"hitTest",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r){var n,i,u,s,o=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(this.tileRenderer){e.next=2;break}return e.abrupt("return",null);case 2:return e.next=4,this.tileRenderer.hitTest(r);case 4:if(n=e.sent,0!==n.length){e.next=7;break}return e.abrupt("return",null);case 7:return e.next=9,this._proxy.getFeatures(n);case 9:return i=e.sent,u=i.features,s=i.aggregates,e.abrupt("return",[].concat((0,a.Z)(s.map((function(e){return o._createHittestResult(x.fromJSON(e))}))),(0,a.Z)(u.map((function(e){return o._createHittestResult(y.Z.fromJSON(e))})))));case 13:case"end":return e.stop()}}),e,this)})));function t(t,r){return e.apply(this,arguments)}return t}()},{key:"queryAggregates",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._proxy.getAggregates();case 2:return e.abrupt("return",e.sent.map((function(e){return x.fromJSON(e)})));case 3:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"queryStatistics",value:function(){return this._proxy.queryStatistics()}},{key:"querySummaryStatistics",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r,n){var a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return a=(0,i.Z)((0,i.Z)({},r),{},{scale:this.view.scale}),e.abrupt("return",this._proxy.querySummaryStatistics(this._cleanUpQuery(t),a,n));case 2:case"end":return e.stop()}}),e,this)})));function t(t,r,n){return e.apply(this,arguments)}return t}()},{key:"queryUniqueValues",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r,n){var a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return a=(0,i.Z)((0,i.Z)({},r),{},{scale:this.view.scale}),e.abrupt("return",this._proxy.queryUniqueValues(this._cleanUpQuery(t),a,n));case 2:case"end":return e.stop()}}),e,this)})));function t(t,r,n){return e.apply(this,arguments)}return t}()},{key:"queryClassBreaks",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r,n){var a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return a=(0,i.Z)((0,i.Z)({},r),{},{scale:this.view.scale}),e.abrupt("return",this._proxy.queryClassBreaks(this._cleanUpQuery(t),a,n));case 2:case"end":return e.stop()}}),e,this)})));function t(t,r,n){return e.apply(this,arguments)}return t}()},{key:"queryHistogram",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r,n){var a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return a=(0,i.Z)((0,i.Z)({},r),{},{scale:this.view.scale}),e.abrupt("return",this._proxy.queryHistogram(this._cleanUpQuery(t),a,n));case 2:case"end":return e.stop()}}),e,this)})));function t(t,r,n){return e.apply(this,arguments)}return t}()},{key:"queryFeatures",value:function(e,t){var r=this;return this.queryFeaturesJSON(e,t).then((function(e){var t=P["default"].fromJSON(e);return t.features.forEach((function(e){return r._setLayersForFeature(e)})),t}))}},{key:"queryVisibleFeatures",value:function(e,t){var r=this;return this._proxy.queryVisibleFeatures(this._cleanUpQuery(e),t).then((function(e){var t=P["default"].fromJSON(e);return t.features.forEach((function(e){return r._setLayersForFeature(e)})),t}))}},{key:"queryFeaturesJSON",value:function(e,t){return this._proxy.queryFeatures(this._cleanUpQuery(e),t)}},{key:"queryObjectIds",value:function(e,t){return this._proxy.queryObjectIds(this._cleanUpQuery(e),t)}},{key:"queryFeatureCount",value:function(e,t){return this._proxy.queryFeatureCount(this._cleanUpQuery(e),t)}},{key:"queryExtent",value:function(e,t){return this._proxy.queryExtent(this._cleanUpQuery(e),t).then((function(e){return{count:e.count,extent:xe.Z.fromJSON(e.extent)}}))}},{key:"setVisibility",value:function(e,t){t?this._visibilityOverrides.delete(e):this._visibilityOverrides.add(e),this._update()}},{key:"update",value:function(e){if(this._tileStrategy&&this.tileRenderer){var t=this._tileStrategy.update(e),r=t.hasMissingTiles,n=t.added,i=t.removed;(n.length||i.length)&&this._proxy.updateTiles({added:n,removed:i}),r&&this.requestUpdate(),this.notifyChange("updating")}}},{key:"attach",value:function(){var e=this;this.view.timeline.record("".concat(this.layer.title," (FeatureLayer) Attach")),this._tileStrategy=new ue({acquireTile:function(t){return e._acquireTile(t)},releaseTile:function(t){return e._releaseTile(t)},tileInfoView:this.view.featuresTilingScheme,buffer:0}),this.handles.add((0,S.S1)(this,"renderingConfigHash",(function(){return e._update()})),"attach"),"stream"!==this.layer.type&&this.handles.add(this.layer.on("edits",(function(t){return e._edit(t)})),"attach")}},{key:"detach",value:function(){this.container.removeAllChildren(),this.handles.remove("attach"),this.tileRenderer&&(this.tileRenderer.uninstall(this.container),this.tileRenderer=null),this._tileStrategy&&(this._tileStrategy.destroy(),this._tileStrategy=null),this._tileRendererHash=null}},{key:"moveStart",value:function(){this.requestUpdate()}},{key:"viewChange",value:function(){this.requestUpdate()}},{key:"moveEnd",value:function(){this.requestUpdate()}},{key:"isUpdating",value:function(){var e,t="renderer"in this.layer&&null!=this.layer.renderer,r=this._commandsQueue.updating,n=null!=this._updatingRequiredFieldsPromise,i=!this._proxy||!this._proxy.isReady,a=this._pipelineIsUpdating,u=null===this.tileRenderer||(null==(e=this.tileRenderer)?void 0:e.updating),s=t&&(r||n||i||a||u);return(0,m.Z)("esri-2d-log-updating"),s}},{key:"_createClientOptions",value:function(){var e=this;return{setUpdating:function(t){e._set("_pipelineIsUpdating",t)},emitEvent:function(t){e.emit(t.name,t.event)}}}},{key:"_detectQueryMode",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){var r,n,i,a,u,s,o,l,c,p,f,h,d,y;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n="path"in t,i="editingInfo"in this.layer&&(null==(r=this.layer.editingInfo)?void 0:r.lastEditDate),a=!!this.layer.refreshInterval,u=!i&&a,!n||"feature"!==this.layer.type&&"subtype-group"!==this.layer.type||"point"!==this.layer.geometryType||!this.layer.capabilities.query.supportsPagination||this.layer.capabilities.operations.supportsEditing||u||!(0,m.Z)("featurelayer-snapshot-enabled")){e.next=16;break}return e.prev=2,e.next=5,this.layer.queryFeatureCount();case 5:if(s=e.sent,!(s<=(0,m.Z)("featurelayer-snapshot-point-min-threshold"))){e.next=8;break}return e.abrupt("return",{mode:"snapshot",featureCount:s});case 8:if(o=(0,m.Z)("featurelayer-snapshot-point-max-threshold"),l=(0,m.Z)("featurelayer-snapshot-point-coverage"),c=this.view.extent,p=(0,E.Wg)(this.layer.fullExtent),f=null==p?void 0:p.clone().intersection(c),h=(0,E.pC)(f)?f.width*f.height:0,d=(null==p?void 0:p.width)*(null==p?void 0:p.height),y=0===d?0:h/d,!(s<=o&&y>=l)){e.next=11;break}return e.abrupt("return",{mode:"snapshot",featureCount:s});case 11:e.next=16;break;case 13:e.prev=13,e.t0=e["catch"](2),we.warn("mapview-feature-layer","Encountered an error when querying for featureCount",{error:e.t0});case 16:return e.abrupt("return",{mode:"on-demand"});case 17:case"end":return e.stop()}}),e,this,[[2,13]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"_createServiceOptions",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(){var t,r,n,i,a,u,s,o,l,c,p,f,h,d,y,v,m,g;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r=this.layer,"stream"!==r.type){e.next=3;break}return e.abrupt("return",null);case 3:if(n=r.capabilities,i=r.objectIdField,a=r.fields.map((function(e){return e.toJSON()})),u=(0,E.pC)(r.fullExtent)&&r.fullExtent.toJSON(),s=(0,re.oq)(r.geometryType),o=r.timeInfo&&r.timeInfo.toJSON()||null,l=r.spatialReference?r.spatialReference.toJSON():null,c="feature"===r.type?r.globalIdField:null,"ogc-feature"!==r.type){e.next=8;break}p=r.source.getFeatureDefinition(),e.next=15;break;case 8:if(!be(r.source)){e.next=14;break}return e.next=11,r.source.openPorts();case 11:p=e.sent,e.next=15;break;case 14:r.parsedUrl&&(p=(0,k.d9)(r.parsedUrl),"dynamicDataSource"in r&&r.dynamicDataSource&&(p.query={layer:JSON.stringify({source:r.dynamicDataSource})}));case 15:return f="datesInUnknownTimezone"in this.layer&&this.layer.datesInUnknownTimezone,h=null!=(t="subtypeField"in this.layer&&this.layer.subtypeField)?t:null,e.next=19,this._detectQueryMode(p);case 19:return d=e.sent,y=d.mode,v=d.featureCount,m=this.layer.objectIdField,"feature"===this.layer.type&&(0,E.pC)(this.layer.orderBy)&&this.layer.orderBy.length&&(g=!this.layer.orderBy[0].valueExpression&&this.layer.orderBy[0].field,g&&(m=g)),e.abrupt("return",{type:y,timeReferenceUnknownClient:f,subtypeField:h,featureCount:v,globalIdField:c,maxRecordCount:n.query.maxRecordCount,tileMaxRecordCount:n.query.tileMaxRecordCount,capabilities:n,fields:a,fullExtent:u,geometryType:s,objectIdField:i,source:p,timeInfo:o,spatialReference:l,orderByFields:m});case 25:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"_createMemoryServiceOptions",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,t.openPorts();case 2:return r=e.sent,e.abrupt("return",(0,i.Z)((0,i.Z)({},this._createServiceOptions()),{},{type:"memory",source:r}));case 4:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"_cleanUpQuery",value:function(e){var t=U.Z.from(e)||this.createQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t}},{key:"_update",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",this._commandsQueue.push({type:"update"}));case 1:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"_edit",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!this._validateEdit(t)){e.next=2;break}return e.abrupt("return",this._commandsQueue.push({type:"edit",edits:t}));case 2:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"doRefresh",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",this._commandsQueue.push({type:"refresh",dataChanged:t}));case 1:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"_validateEdit",value:function(e){var t="globalIdField"in this.layer&&this.layer.globalIdField,r=e.deletedFeatures.some((function(e){return-1===e.objectId||!e.objectId})),n=t&&this.availableFields.includes(t);return r&&!n?(we.error(new w.Z("mapview-apply-edits","Editing the specified service requires the layer's globalIdField, ".concat(t," to be included the layer's outFields for updates to be reflected on the map"))),null):e}},{key:"_doUpdate",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(){var t,r,n,i,a,u,s,o,l,c,p,f,h,d;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(e.prev=0,!this.destroyed&&this._hasRequiredSupport(this.layer)&&this._tileStrategy){e.next=3;break}return e.abrupt("return");case 3:return t=this.featureEffectView,r=this.filter,e.next=6,this._updateRequiredFields();case 6:return n=this._getEffectiveRenderer(),i=n.renderer,this._set("_effectiveRenderer",i),a=this._createSchemaConfig(),u=(0,re.oq)(this.layer.geometryType),e.next=12,(0,j.G)(i,u,this.view.resourceManager,this.layer.fields,this.layer.spatialReference,this.layer.featureReduction);case 12:if(s=e.sent,o=this._createConfiguration(a,r,t.filter),l=this._lastDefinitionExpression!==o.definitionExpression,this._lastDefinitionExpression=o.definitionExpression,this._lastPixelBuffer=0===s?0:Math.max(s,this._lastPixelBuffer),o.schema.source.pixelBuffer=this._lastPixelBuffer,c=this._createTileRendererHash(i),"snapshot"===this._serviceOptions.type&&(o.schema.source.featureCount=this._serviceOptions.featureCount),c===this._tileRendererHash){e.next=44;break}return e.next=20,this._initTileRenderer(i);case 20:if(p=this._serviceOptions,this.tileRenderer.onConfigUpdate(i),f=this.layer,e.t0="stream"!==f.type&&be(f.source),!e.t0){e.next=28;break}return e.next=27,f.source.openPorts();case 27:p.source=e.sent;case 28:if(e.t1="stream"===f.type,!e.t1){e.next=32;break}return e.next=32,this._initServiceOptions();case 32:return h={added:this._tileStrategy.tileKeys(),removed:[]},e.next=35,this._proxy.startup(this.view.featuresTilingScheme,o,p,h);case 35:if(e.t2=this.hasHighlight(),!e.t2){e.next=39;break}return e.next=39,this._proxy.setHighlight(Array.from(this._highlightIds.keys()));case 39:return e.next=41,this._onceTilesUpdated();case 41:this.tileRenderer.onConfigUpdate(i),e.next=62;break;case 44:if(e.t3="snapshot"===this._serviceOptions.type&&l,!e.t3){e.next=49;break}return e.next=48,this.layer.queryFeatureCount();case 48:o.schema.source.featureCount=e.sent;case 49:return e.next=51,this._proxy.update(o);case 51:return d=e.sent,(d.mesh||d.targets.aggregate)&&this._lockGPUUploads(),e.prev=53,e.next=56,this._proxy.applyUpdate(d);case 56:e.next=61;break;case 58:e.prev=58,e.t4=e["catch"](53),(0,Z.D_)(e.t4)||we.error(e.t4);case 61:(d.mesh||d.targets.aggregate)&&this._unlockGPUUploads(),this.tileRenderer.onConfigUpdate(i),this._updateClusterSizeVariable(),this._forceAttributeTextureUpload();case 62:this._tileRendererHash=c,this.tileRenderer.invalidateLabels(),this.requestUpdate(),e.next=67;break;case 65:e.prev=65,e.t5=e["catch"](0);case 67:case"end":return e.stop()}}),e,this,[[0,65],[53,58]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"_doEdit",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._proxy.onEdits(t);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e["catch"](0),(0,Z.D_)(e.t0);case 8:case"end":return e.stop()}}),e,this,[[0,5]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"_doRefresh",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return this._lockGPUUploads(),e.prev=1,e.next=4,this._proxy.refresh(t);case 4:e.next=9;break;case 6:e.prev=6,e.t0=e["catch"](1),(0,Z.D_)(e.t0);case 9:this._unlockGPUUploads();case 10:case"end":return e.stop()}}),e,this,[[1,6]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"_updateClusterSizeVariable",value:function(){this._needsClusterSizeUpdate&&(this.tileRenderer.onConfigUpdate(this._effectiveRenderer),this._needsClusterSizeUpdate=!1)}},{key:"_createUpdateClusterSizeTask",value:function(e,t){var r=this;return this.watch("_aggregateValueRanges",function(){var n=(0,s.Z)(regeneratorRuntime.mark((function n(i){return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:r._updateClusterEffectiveRendererSizeVariable(e,t,i),r._needsClusterSizeUpdate=!0,r._uploadsLocked||r._updateClusterSizeVariable();case 1:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}())}},{key:"_updateClusterEffectiveRendererSizeVariable",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t,r,n){var i,a,u;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:t.dynamicClusterSize&&"visualVariables"in t&&t.visualVariables&&(i=(0,J.os)(t.visualVariables),(0,E.pC)(i)&&"cluster_count"===i.field&&(a=t.visualVariables.indexOf(i),t.visualVariables[a]=(0,J.aV)(r,n),u=t.clone(),u.dynamicClusterSize=!0,this._set("_effectiveRenderer",u)));case 1:case"end":return e.stop()}}),e,this)})));function t(t,r,n){return e.apply(this,arguments)}return t}()},{key:"_getEffectiveRenderer",value:function(){var e="renderer"in this.layer&&this.layer.renderer,t=this.layer.featureReduction;if((0,E.pC)(this._updateClusterSizeTask)&&(this._updateClusterSizeTask.remove(),this._updateClusterSizeTask=null),t&&"cluster"===t.type&&(0,J.yR)(e)){var r=t,n=[],i=(0,J.S1)(n,e,r,this._aggregateValueRanges);return(0,E.Po)(this._updateClusterSizeTask,(function(e){return e.remove()})),this._updateClusterSizeTask=this._createUpdateClusterSizeTask(i,r),{renderer:i,aggregateFields:n,featureReduction:t}}return{renderer:e,aggregateFields:[],featureReduction:null}}},{key:"_acquireTile",value:function(e){var t=this,r=this.tileRenderer.acquireTile(e);return r.once("attach",(function(){t.requestUpdate()})),r}},{key:"_releaseTile",value:function(e){this.tileRenderer.releaseTile(e)}},{key:"_initTileRenderer",value:function(){var e=(0,s.Z)(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,L(t,{layerView:this,tileInfoView:this.view.featuresTilingScheme,layer:this.layer});case 2:return r=e.sent,e.abrupt("return",(this.tileRenderer&&(this._tileStrategy.clear(),this.tileRenderer.uninstall(this.container),this.tileRenderer.destroy(),this.tileRenderer=null),this.destroyed?null:(this._proxy.tileRenderer=r,this._set("tileRenderer",r),this.tileRenderer.install(this.container),this.tileRenderer.onConfigUpdate(t),this.requestUpdate(),this.tileRenderer)));case 4:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"_createTileRendererHash",value:function(e){return"".concat("heatmap"===e.type?"heatmap":"symbol",".").concat("dot-density"===e.type)}},{key:"hasFilter",get:function(){var e=!!("floorInfo"in this.layer&&this.layer.floorInfo&&this.view.floors&&this.view.floors.length);return!!this.filter||e||!!this._visibilityOverrides.size||!!this.timeExtent}},{key:"_injectOverrides",value:function(e){var t=(0,E.pC)(e)?e.timeExtent:null,r=(0,E.pC)(this.timeExtent)&&(0,E.pC)(t)?this.timeExtent.intersection(t):this.timeExtent||t,n=null,i="floorInfo"in this.layer&&this.layer.floorInfo;if(i){var a=(0,E.pC)(e)&&e.where;n=this._addFloorFilterClause(a)}if(!this._visibilityOverrides.size&&!r&&!i)return(0,E.pC)(e)?e.toJSON():null;(e=(0,E.pC)(e)&&e.clone()||new V.Z).timeExtent=r,n&&(e.where=n);var u=e.toJSON();return u.hiddenIds=Array.from(this._visibilityOverrides),u}},{key:"_addFloorFilterClause",value:function(e){var t=this.layer,r=e||"";if("floorInfo"in t&&t.floorInfo){var n,i=this.view.floors;if(!i||!i.length)return r;null!=(n=t.floorInfo.viewAllLevelIds)&&n.length&&(i=t.floorInfo.viewAllLevelIds);var a=i.filter((function(e){return""!==e})).map((function(e){return"'"+e+"'"}));a.push("''");var u=t.floorInfo.floorField,s="("+u+" IN ({ids}) OR "+u+" IS NULL)";if(s=s.replace("{ids}",a.join(", ")),(0,E.pC)(r)&&r.includes(u)){var o=new RegExp("AND \\("+u+".*NULL\\)","g");r=r.replace(o,""),o=new RegExp("\\("+u+".*NULL\\)","g"),r=r.replace(o,""),r=r.replace(/\s+/g," ").trim()}r=""!==r?"("+r+") AND "+s:s}return""!==r?r:null}},{key:"_createConfiguration",value:function(e,t,r){var n="feature"===this.layer.type&&this.layer.historicMoment?this.layer.historicMoment.getTime():void 0,i="feature"===this.layer.type?this.layer.gdbVersion:void 0,a=new Array(N.m4),u=this._injectOverrides(t);a[0]=u,a[1]=(0,E.pC)(r)?r.toJSON():null;var s=(0,z.createSchema)(e);if((0,E.Wi)(s))return null;var o=(0,_e.Z)();return{definitionExpression:this.layer.definitionExpression,availableFields:this.availableFields,gdbVersion:i,historicMoment:n,devicePixelRatio:window.devicePixelRatio||1,filters:a,schema:s,supportsTextureFloat:o.supportsTextureFloat,maxTextureSize:o.maxTextureSize}}},{key:"_hasRequiredSupport",value:function(e){var t;return!("renderer"in e&&"dot-density"===(null==(t=e.renderer)?void 0:t.type)&&!(0,_e.Z)().supportsTextureFloat)||(we.error(new w.Z("webgl-missing-extension","Missing WebGL extension OES_Texture_Float which is required for DotDensity")),!1)}},{key:"_onceTilesUpdated",value:function(){return this.requestUpdate(),(0,S.OY)(this,"_pipelineIsUpdating",!1)}},{key:"_lockGPUUploads",value:function(){this.tileRenderer&&(this._uploadsLocked=!0,this.tileRenderer.lockGPUUploads())}},{key:"_unlockGPUUploads",value:function(){this.tileRenderer&&(this._uploadsLocked=!1,this.tileRenderer.unlockGPUUploads())}},{key:"_forceAttributeTextureUpload",value:function(){this.tileRenderer&&this.tileRenderer.forceAttributeTextureUpload()}},{key:"_createSchemaConfig",value:function(){var e="feature"===this.layer.type?this.layer.historicMoment:null,t="feature"===this.layer.type?this.layer.gdbVersion:null;return{renderer:"renderer"in this.layer&&this.layer.renderer,spatialReference:this.layer.spatialReference,timeExtent:this.layer.timeExtent,definitionExpression:this.layer.definitionExpression,featureReduction:this.layer.featureReduction,fields:this.layer.fields,geometryType:this.layer.geometryType,historicMoment:e,labelsVisible:"labelsVisible"in this.layer&&this.layer.labelsVisible,labelingInfo:"labelingInfo"in this.layer&&this.layer.labelingInfo,availableFields:this.availableFields,featureEffect:this.featureEffect,filter:this.filter,gdbVersion:t,pixelBuffer:0,orderBy:"orderBy"in this.layer&&this.layer.orderBy?this.layer.orderBy:null,customParameters:(0,i.Z)((0,i.Z)({},"customParameters"in this.layer?this.layer.customParameters:void 0),{},{token:"apiKey"in this.layer?this.layer.apiKey:void 0})}}},{key:"_addHighlight",value:function(e){var t,r=(0,u.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(this._highlightIds.has(n)){var i=this._highlightIds.get(n);this._highlightIds.set(n,i+1)}else this._highlightIds.set(n,1)}}catch(a){r.e(a)}finally{r.f()}this._updateHighlight().catch((function(e){(0,Z.D_)(e)||we.error(e)}))}},{key:"_removeHighlight",value:function(e){var t,r=(0,u.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(this._highlightIds.has(n)){var i=this._highlightIds.get(n)-1;0===i?this._highlightIds.delete(n):this._highlightIds.set(n,i)}}}catch(a){r.e(a)}finally{r.f()}this._updateHighlight().catch((function(e){(0,Z.D_)(e)||we.error(e)}))}},{key:"_setLayersForFeature",value:function(e){var t=this.layer;e.layer=t,e.sourceLayer=t}},{key:"_createHittestResult",value:function(e){return this._setLayersForFeature(e),(0,E.pC)(e.geometry)&&(e.geometry.spatialReference=this.view.spatialReference),e}}]),r}(ye((0,me.y)((0,A.y)(ve.Z))));(0,d._)([(0,v.Cb)()],ke.prototype,"_serviceOptions",void 0),(0,d._)([(0,v.Cb)()],ke.prototype,"_proxy",void 0),(0,d._)([(0,v.Cb)()],ke.prototype,"_pipelineIsUpdating",void 0),(0,d._)([(0,v.Cb)()],ke.prototype,"_effectiveRenderer",void 0),(0,d._)([(0,v.Cb)()],ke.prototype,"_aggregateValueRanges",void 0),(0,d._)([(0,v.Cb)()],ke.prototype,"_commandsQueue",void 0),(0,d._)([(0,v.Cb)()],ke.prototype,"featureEffectView",void 0),(0,d._)([(0,v.Cb)()],ke.prototype,"labelsVisible",null),(0,d._)([(0,v.Cb)({readOnly:!0})],ke.prototype,"queryMode",null),(0,d._)([(0,v.Cb)()],ke.prototype,"renderingConfigHash",null),(0,d._)([(0,v.Cb)()],ke.prototype,"tileRenderer",void 0),(0,d._)([(0,v.Cb)()],ke.prototype,"updating",void 0),ke=(0,d._)([(0,g.j)("esri.views.2d.layers.FeatureLayerView2D")],ke);var Re=ke},31567:function(e,t,r){r.d(t,{xS:function(){return S},B3:function(){return C}});var n=r(16198),i=(r(78975),r(41539),r(78783),r(33948),r(21249),r(9816)),a=r(62032),u=r(76133),s=r(92751),o=r(49026),l=r(72239),c={marker:o.LW.MARKER,fill:o.LW.FILL,line:o.LW.LINE,text:o.LW.TEXT},p=function(){function e(t,r,n,i){(0,u.Z)(this,e);var s={minScale:null==r?void 0:r.minScale,maxScale:null==r?void 0:r.maxScale},o=f(s);this.layers=t,this.data=r,this.hash=this._createHash()+o,this.rendererKey=n;var p,h={isOutline:!1,isOutlinedFill:!1,placement:null,stride:{fill:"default"},vvFlags:n},d=(0,a.Z)(t);try{for(d.s();!(p=d.n()).done;){var y=p.value,v=c[y.type];y.materialKey=(0,l.jj)(v,h),y.maxVVSize=i,y.scaleInfo=s,y.templateHash+=o}}catch(m){d.e(m)}finally{d.f()}}return(0,s.Z)(e,[{key:"type",get:function(){return"expanded-cim"}},{key:"_createHash",value:function(){var e,t="",r=(0,a.Z)(this.layers);try{for(r.s();!(e=r.n()).done;){var n=e.value;t+=n.templateHash}}catch(i){r.e(i)}finally{r.f()}return t}}]),e}();function f(e){return e.minScale||e.maxScale?e.minScale+"-"+e.maxScale:""}r(68309),r(74916),r(15306),r(69826);var h=r(5246),d=r(25585),y=r(24446),v=r(58476),m=r(88096),g=r(93554),_=r(66328);function x(e,t,r){return b.apply(this,arguments)}function b(){return b=(0,n.Z)(regeneratorRuntime.mark((function e(t,r,n){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.name){e.next=2;break}return e.abrupt("return",Promise.reject(new d.Z("style-symbol-reference-name-missing","Missing name in style symbol reference")));case 2:if(!t.styleName||"Esri2DPointSymbolsStyle"!==t.styleName){e.next=4;break}return e.abrupt("return",w(t,n));case 4:return e.prev=4,e.t0=R,e.next=8,(0,_.n2)(t,r,n);case 8:return e.t1=e.sent,e.t2=t.name,e.t3=r,e.t4=n,e.abrupt("return",(0,e.t0)(e.t1,e.t2,e.t3,e.t4));case 15:return e.prev=15,e.t5=e["catch"](4),e.abrupt("return",((0,y.k_)(e.t5),null));case 18:case"end":return e.stop()}}),e,null,[[4,15]])}))),b.apply(this,arguments)}function w(e,t){return k.apply(this,arguments)}function k(){return k=(0,n.Z)(regeneratorRuntime.mark((function e(t,r){var n,i;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=_.wm.replace(/\{SymbolName\}/gi,t.name),e.prev=1,e.next=4,(0,_.EJ)(n,r);case 4:return i=e.sent,e.abrupt("return",(0,_.KV)(i.data));case 8:return e.prev=8,e.t0=e["catch"](1),e.abrupt("return",((0,y.k_)(e.t0),null));case 11:case"end":return e.stop()}}),e,null,[[1,8]])}))),k.apply(this,arguments)}function R(e,t,r,n){return E.apply(this,arguments)}function E(){return E=(0,n.Z)(regeneratorRuntime.mark((function e(t,r,n,i){var a,u,s,o,l;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(a=t.data,u={portal:n&&n.portal||m.Z.getDefault(),url:(0,v.mN)(t.baseUrl),origin:"portal-item"},s=a.items.find((function(e){return e.name===r})),s){e.next=3;break}throw new d.Z("symbolstyleutils:symbol-name-not-found","The symbol name '".concat(r,"' could not be found"),{symbolName:r});case 3:return o=(0,g.f)((0,_.v9)(s,"cimRef"),u),(0,h.XO)()&&(o=(0,h.pJ)(o)),e.prev=5,e.next=8,(0,_.EJ)(o,i);case 8:return l=e.sent,e.abrupt("return",(0,_.KV)(l.data));case 12:return e.prev=12,e.t0=e["catch"](5),e.abrupt("return",((0,y.k_)(e.t0),null));case 15:case"end":return e.stop()}}),e,null,[[5,12]])}))),E.apply(this,arguments)}var Z=function(){var e=(0,n.Z)(regeneratorRuntime.mark((function e(t,r,n){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.t0=p,e.next=3,(0,i.c)(t.data,r,n);case 3:return e.t1=e.sent,e.t2=t.data,e.t3=t.rendererKey,e.t4=t.maxVVSize,e.abrupt("return",new e.t0(e.t1,e.t2,e.t3,e.t4));case 8:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),C=function(){var e=(0,n.Z)(regeneratorRuntime.mark((function e(t,r,n,i){var a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return",null);case 2:if("cim"!==t.type){e.next=4;break}return e.abrupt("return",Z(t,r,n));case 4:if("web-style"!==t.type){e.next=12;break}return e.next=7,x(t,null,i);case 7:return e.t0=e.sent,e.t1=t.rendererKey,e.t2=t.maxVVSize,a={type:"cim",data:e.t0,rendererKey:e.t1,maxVVSize:e.t2},e.abrupt("return",Z(a,r,n));case 12:return e.abrupt("return",t);case 13:case"end":return e.stop()}}),e)})));return function(t,r,n,i){return e.apply(this,arguments)}}();function S(e){if(!e)return null;var t=e.type,r=e.cim,n=e.url,i=e.materialHash,a={cim:r,type:t,mosaicHash:i,url:n,size:null,dashTemplate:null,path:null,text:null,fontName:null};switch(t){case"marker":a.size=e.size,a.path=e.path;break;case"line":a.dashTemplate=e.dashTemplate;break;case"text":a.text=e.text,a.fontName=e.fontName}return a}},66541:function(e,t,r){r.d(t,{V:function(){return l},e:function(){return s}});var n=r(1936),i=r(16198),a=(r(78975),r(26699),r(32023),r(92222),r(41539),r(54747),r(27092)),u=r(63390);function s(e){return o.apply(this,arguments)}function o(){return o=(0,i.Z)(regeneratorRuntime.mark((function e(t){var r,i,s,o,l,c,p,f,h,d=arguments;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r=d.length>1&&void 0!==d[1]?d[1]:t.popupTemplate,(0,a.pC)(r)){e.next=3;break}return e.abrupt("return",[]);case 3:return e.next=5,r.getRequiredFields(t.fieldsIndex);case 5:if(i=e.sent,s=r.lastEditInfoEnabled,o=t.objectIdField,l=t.typeIdField,c=t.globalIdField,p=t.relationships,!i.includes("*")){e.next=13;break}return e.abrupt("return",["*"]);case 13:if(!s){e.next=19;break}return e.next=16,(0,u.CH)(t);case 16:e.t0=e.sent,e.next=20;break;case 19:e.t0=[];case 20:return f=e.t0,h=(0,u.Q0)(t.fieldsIndex,[].concat((0,n.Z)(i),(0,n.Z)(f))),e.abrupt("return",(l&&h.push(l),h&&o&&t.fieldsIndex.has(o)&&-1===h.indexOf(o)&&h.push(o),h&&c&&t.fieldsIndex.has(c)&&-1===h.indexOf(c)&&h.push(c),p&&p.forEach((function(e){var r=e.keyField;h&&r&&t.fieldsIndex.has(r)&&-1===h.indexOf(r)&&h.push(r)})),h));case 23:case"end":return e.stop()}}),e)}))),o.apply(this,arguments)}function l(e,t){return e.popupTemplate?e.popupTemplate:(0,a.pC)(t)&&t.defaultPopupTemplateEnabled&&(0,a.pC)(e.defaultPopupTemplate)?e.defaultPopupTemplate:null}},96237:function(e,t,r){r.d(t,{K:function(){return u}});r(75065);var n=r(27092),i=r(19509),a=(r(58489),r(7230));function u(e,t,r){var u,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new a.Z;if("2d"===r.type)u=t*r.resolution;else if("3d"===r.type){var o=r.overlayPixelSizeInMapUnits(e),l=r.basemapSpatialReference;u=(0,n.pC)(l)&&!l.equals(r.spatialReference)?(0,i.c9)(l)/(0,i.c9)(r.spatialReference):t*o}var c=e.x-u,p=e.y-u,f=e.x+u,h=e.y+u,d=r.spatialReference;return s.xmin=Math.min(c,f),s.ymin=Math.min(p,h),s.xmax=Math.max(c,f),s.ymax=Math.max(p,h),s.spatialReference=d,s}new a.Z}}]);